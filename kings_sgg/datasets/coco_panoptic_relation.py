import numpy as np
from collections import defaultdict

from mmdet.datasets.builder import DATASETS
from mmdet.datasets.coco_panoptic import COCOPanoptic, CocoPanopticDataset


thing_classes = ['person', 'bicycle', 'car', 'motorcycle', 'airplane',
                 'bus', 'train', 'truck', 'boat', 'traffic light',
                 'fire hydrant', 'stop sign', 'parking meter', 'bench',
                 'bird', 'cat', 'dog', 'horse', 'sheep', 'cow', 'elephant',
                 'bear', 'zebra', 'giraffe', 'backpack', 'umbrella',
                 'handbag', 'tie', 'suitcase', 'frisbee', 'skis',
                 'snowboard', 'sports ball', 'kite', 'baseball bat',
                 'baseball glove', 'skateboard', 'surfboard', 'tennis racket',
                 'bottle', 'wine glass', 'cup', 'fork', 'knife', 'spoon',
                 'bowl', 'banana', 'apple', 'sandwich', 'orange', 'broccoli',
                 'carrot', 'hot dog', 'pizza', 'donut', 'cake', 'chair',
                 'couch', 'potted plant', 'bed', 'dining table', 'toilet',
                 'tv', 'laptop', 'mouse', 'remote', 'keyboard', 'cell phone',
                 'microwave', 'oven', 'toaster', 'sink', 'refrigerator',
                 'book', 'clock', 'vase', 'scissors', 'teddy bear',
                 'hair drier', 'toothbrush']
stuff_classes = ['banner', 'blanket', 'bridge', 'cardboard', 'counter',
                 'curtain', 'door-stuff', 'floor-wood', 'flower', 'fruit',
                 'gravel', 'house', 'light', 'mirror-stuff', 'net', 'pillow',
                 'platform', 'playingfield', 'railroad', 'river', 'road',
                 'roof', 'sand', 'sea', 'shelf', 'snow', 'stairs', 'tent',
                 'towel', 'wall-brick', 'wall-stone', 'wall-tile', 'wall-wood',
                 'water-other', 'window-blind', 'window-other', 'tree-merged',
                 'fence-merged', 'ceiling-merged', 'sky-other-merged',
                 'cabinet-merged', 'table-merged', 'floor-other-merged',
                 'pavement-merged', 'mountain-merged', 'grass-merged',
                 'dirt-merged', 'paper-merged', 'food-other-merged',
                 'building-other-merged', 'rock-merged', 'wall-other-merged',
                 'rug-merged']
relation_classes = ['over', 'in front of', 'beside', 'on', 'in', 'attached to',
                    'hanging from', 'on back of', 'falling off', 'going down',
                    'painted on', 'walking on', 'running on', 'crossing',
                    'standing on', 'lying on', 'sitting on', 'flying over',
                    'jumping over', 'jumping from', 'wearing', 'holding',
                    'carrying', 'looking at', 'guiding', 'kissing', 'eating',
                    'drinking', 'feeding', 'biting', 'catching', 'picking',
                    'playing with', 'chasing', 'climbing', 'cleaning', 'playing',
                    'touching', 'pushing', 'pulling', 'opening', 'cooking',
                    'talking to', 'throwing', 'slicing', 'driving', 'riding',
                    'parked on', 'driving on', 'about to hit', 'kicking',
                    'swinging', 'entering', 'exiting', 'enclosing', 'leaning on']
relation_description_gpt4_v0 = [
    '"Over" is a term used to describe the spatial relationship between two objects in an image, where one object is positioned above and typically covering or extending beyond the other object. The object that is "over" appears to be resting or hovering on top of the other object without necessarily touching it, creating a sense of vertical hierarchy or layering. This relationship can be observed in various contexts, such as a hat being "over" someone\'s head, a bridge "over" a river, or a blanket "over" a bed. The term "over" helps convey the arrangement and relative positioning of objects within an image, allowing for a better understanding of the scene or composition.',
    '"In front of" is a term used to describe the spatial relationship between two objects in an image, where one object is positioned closer to the viewer and partially or completely obscuring the other object from view. This relationship implies a foreground and background arrangement, with the object "in front of" being nearer to the observer, while the other object is situated behind it. The term "in front of" helps to communicate depth and relative positioning within an image, enabling a better comprehension of the scene or composition. For example, a person standing "in front of" a building, a tree "in front of" a mountain, or a car parked "in front of" a house. This spatial relationship can be observed in various contexts and is essential in understanding the visual hierarchy and organization of objects within an image.',
    '"Beside" is a term used to describe the spatial relationship between two objects in an image, where one object is positioned horizontally adjacent to the other object, sharing the same plane or level. This relationship implies a side-by-side arrangement, with both objects maintaining a relatively equal distance from the viewer and neither object obscuring the other from view. The term "beside" helps to convey the lateral positioning and proximity of objects within an image, enabling a better understanding of the scene or composition. For example, a book lying "beside" a laptop on a desk, two friends standing "beside" each other, or a bicycle parked "beside" a bench. This spatial relationship can be observed in various contexts and is essential in grasping the arrangement and organization of objects within an image without any significant vertical or depth differences between them.',
    '"On" is a term used to describe the spatial relationship between two objects in an image, where one object is positioned directly above and in contact with the surface of the other object, typically exerting some form of pressure or weight. This relationship implies a sense of support or resting, as the lower object serves as a base or foundation for the upper object. The term "on" helps to convey the arrangement and interaction between objects within an image, enabling a better understanding of the scene or composition. For example, a cup "on" a table, a hat "on" someone\'s head, or a painting "on" a wall. This spatial relationship can be observed in various contexts and is essential in grasping the placement, organization, and connection of objects within an image, emphasizing the direct contact and shared surface between them.',
    '"In" is a term used to describe the spatial relationship between two objects in an image, where one object is enclosed, surrounded, or contained within the boundaries or interior space of the other object. This relationship implies a sense of inclusion, as the outer object serves as a vessel, frame, or enclosure for the inner object. The term "in" helps to convey the arrangement and interaction between objects within an image, enabling a better understanding of the scene or composition. For example, a person sitting "in" a car, fruits "in" a bowl, or a picture "in" a frame. This spatial relationship can be observed in various contexts and is essential in grasping the placement, organization, and connection of objects within an image, emphasizing the encapsulating nature and shared boundaries between them.',
    '"Attached to" is a term used to describe the spatial relationship between two objects in an image, where one object is connected or affixed to the other object through a bond, joint, or fastening mechanism. This relationship implies a sense of union or linkage, as the two objects become a single entity or system by being joined together, either temporarily or permanently. The term "attached to" helps to convey the arrangement and interaction between objects within an image, enabling a better understanding of the scene or composition. For example, a trailer "attached to" a truck, a pendant "attached to" a necklace, or a handle "attached to" a door. This spatial relationship can be observed in various contexts and is essential in grasping the placement, organization, and connection of objects within an image, emphasizing the unifying nature and interdependence between them.',
    '"Hanging from" is a term used to describe the spatial relationship between two objects in an image, where one object is suspended below and connected to the other object, typically by a rope, chain, hook, or other attaching mechanism. This relationship implies a sense of vertical dependency, as the upper object serves as a support or anchor point for the lower object, which is left dangling or swaying freely in the air. The term "hanging from" helps to convey the arrangement and interaction between objects within an image, enabling a better understanding of the scene or composition. For example, a chandelier "hanging from" a ceiling, a swing "hanging from" a tree branch, or a sign "hanging from" a storefront. This spatial relationship can be observed in various contexts and is essential in grasping the placement, organization, and connection of objects within an image, emphasizing the suspending nature and vertical alignment between them.',
    '"On back of" is a term used to describe the spatial relationship between two objects in an image, where one object is positioned on the rear or posterior surface of the other object, typically in direct contact or closely following its contours. This relationship implies a sense of support or connection, as the front or primary object serves as a base or foundation for the secondary object placed on its backside. The term "on back of" helps to convey the arrangement and interaction between objects within an image, enabling a better understanding of the scene or composition. For example, a backpack "on the back of" a person, a rider "on the back of" a horse, or a cargo "on the back of" a truck. This spatial relationship can be observed in various contexts and is essential in grasping the placement, organization, and connection of objects within an image, emphasizing the direct contact and shared surface between the front and rear-facing elements.',
    '"Falling off" is a term used to describe the spatial relationship between two objects in an image, where one object is in the process of detaching or separating from the other object and appears to be descending or moving downward due to gravity. This relationship implies a sense of loss of balance, support, or connection, as the initial point of contact or attachment between the objects is disrupted, causing the falling object to move away from its original position. The term "falling off" helps to convey the arrangement and interaction between objects within an image, enabling a better understanding of the scene or composition. For example, a vase "falling off" a shelf, a person "falling off" a bicycle, or leaves "falling off" a tree. This spatial relationship can be observed in various contexts and is essential in grasping the placement, organization, and connection of objects within an image, emphasizing the dynamic nature of the scene and the ongoing change in position and orientation between the involved elements.',
    '"Going down" is a term used to describe the spatial relationship between two objects in an image, where one object is in the process of moving or descending vertically or on an inclined plane in relation to the other object. This relationship implies a sense of downward motion or change in elevation, as the moving object transitions from a higher position to a lower one while maintaining its orientation. The term "going down" helps to convey the arrangement and interaction between objects within an image, enabling a better understanding of the scene or composition. For example, a person "going down" a staircase, a vehicle "going down" a hill, or an elevator "going down" in a building. This spatial relationship can be observed in various contexts and is essential in grasping the placement, organization, and connection of objects within an image, emphasizing the dynamic nature of the scene and the ongoing change in position and altitude between the involved elements.',
    '"Painted on" is a term used to describe the spatial relationship between two objects in an image, where one object is a design, pattern, or artwork that has been applied directly onto the surface of the other object using paint, pigment, or a similar medium. This relationship implies a sense of artistic expression and decoration, as the painted object visually enhances or modifies the appearance of the base object it is applied to. The term "painted on" helps to convey the arrangement and interaction between objects within an image, enabling a better understanding of the scene or composition. For example, a mural "painted on" a wall, a logo "painted on" a car, or a face "painted on" a canvas. This spatial relationship can be observed in various contexts and is essential in grasping the placement, organization, and connection of objects within an image, emphasizing the creative and visual fusion between the artwork and the surface it is applied to.',
    '"Walking on" is a term used to describe the spatial relationship between two objects in an image, where one object, typically a living being like a person or an animal, is in the process of moving or traversing across the surface of the other object using their legs or appendages. This relationship implies a sense of active engagement and interaction, as the walking object maintains direct contact with the surface of the other object while propelling itself forward. The term "walking on" helps to convey the arrangement and interaction between objects within an image, enabling a better understanding of the scene or composition. For example, a person "walking on" a sidewalk, a dog "walking on" a beach, or an insect "walking on" a leaf. This spatial relationship can be observed in various contexts and is essential in grasping the placement, organization, and connection of objects within an image, emphasizing the dynamic nature of the scene and the ongoing change in position and orientation between the involved elements.',
    '"Running on" is a term used to describe the spatial relationship between two objects in an image, where one object, typically a living being like a person or an animal, is in the process of moving rapidly or sprinting across the surface of the other object using their legs or appendages. This relationship implies a sense of dynamic engagement, speed, and interaction, as the running object maintains direct contact with the surface of the other object while propelling itself forward at an accelerated pace. The term "running on" helps to convey the arrangement and interaction between objects within an image, enabling a better understanding of the scene or composition. For example, a person "running on" a track, a horse "running on" a field, or a cheetah "running on" a savannah. This spatial relationship can be observed in various contexts and is essential in grasping the placement, organization, and connection of objects within an image, emphasizing the dynamic nature of the scene and the ongoing change in position and orientation between the involved elements.',
    '"Crossing" is a term used to describe the spatial relationship between two objects in an image, where one object is in the process of moving over, under, or through the other object, often at an angle or intersection. This relationship implies a sense of traversal, interaction, and temporary connection, as the crossing object passes by or navigates through the other object, eventually reaching the other side or continuing on its path. The term "crossing" helps to convey the arrangement and interaction between objects within an image, enabling a better understanding of the scene or composition. For example, a pedestrian "crossing" a road, a train "crossing" a bridge, or a bird "crossing" the sky in front of a mountain. This spatial relationship can be observed in various contexts and is essential in grasping the placement, organization, and connection of objects within an image, emphasizing the dynamic nature of the scene and the ongoing change in position and orientation between the involved elements.',
    '"Standing on" is a term used to describe the spatial relationship between two objects in an image, where one object, typically a living being like a person or an animal, is in a stationary upright position with their legs or appendages supporting their weight on the surface of the other object. This relationship implies a sense of balance, stability, and interaction, as the standing object maintains direct contact with the surface of the other object while remaining motionless or relatively still. The term "standing on" helps to convey the arrangement and interaction between objects within an image, enabling a better understanding of the scene or composition. For example, a person "standing on" a stage, a bird "standing on" a branch, or a statue "standing on" a pedestal. This spatial relationship can be observed in various contexts and is essential in grasping the placement, organization, and connection of objects within an image, emphasizing the static nature of the scene and the ongoing contact and support between the involved elements.',
    '"Lying on" is a term used to describe the spatial relationship between two objects in an image, where one object, typically a living being or an inanimate item, is in a horizontal or reclining position, resting on the surface of the other object. This relationship implies a sense of relaxation, support, and interaction, as the lying object maintains direct contact with the surface of the other object while remaining motionless or relatively still. The term "lying on" helps to convey the arrangement and interaction between objects within an image, enabling a better understanding of the scene or composition. For example, a person "lying on" a bed, a book "lying on" a table, or a cat "lying on" a windowsill. This spatial relationship can be observed in various contexts and is essential in grasping the placement, organization, and connection of objects within an image, emphasizing the static nature of the scene and the ongoing contact and support between the involved elements.',
    '"Sitting on" is a term used to describe the spatial relationship between two objects in an image, where one object, typically a living being like a person or an animal, is in a seated or resting position with their legs or appendages bent and their weight supported by the surface of the other object. This relationship implies a sense of relaxation, stability, and interaction, as the sitting object maintains direct contact with the surface of the other object while remaining motionless or relatively still. The term "sitting on" helps to convey the arrangement and interaction between objects within an image, enabling a better understanding of the scene or composition. For example, a person "sitting on" a chair, a bird "sitting on" a fence, or a dog "sitting on" a porch. This spatial relationship can be observed in various contexts and is essential in grasping the placement, organization, and connection of objects within an image, emphasizing the static nature of the scene and the ongoing contact and support between the involved elements.',
    '"Flying over" is a term used to describe the spatial relationship between two objects in an image, where one object, typically a living being like a bird or an airborne vehicle like a plane or drone, is in the process of moving through the air at an elevated position above the other object. This relationship implies a sense of altitude, freedom, and interaction, as the flying object maintains a certain distance from the surface of the other object while traversing the airspace above it. The term "flying over" helps to convey the arrangement and interaction between objects within an image, enabling a better understanding of the scene or composition. For example, a bird "flying over" a lake, a plane "flying over" a city, or a hot air balloon "flying over" a mountain range. This spatial relationship can be observed in various contexts and is essential in grasping the placement, organization, and connection of objects within an image, emphasizing the dynamic nature of the scene and the ongoing change in position and altitude between the involved elements.',
    '"Jumping over" is a term used to describe the spatial relationship between two objects in an image, where one object, typically a living being like a person or an animal, is in the process of propelling itself through the air by exerting force against the ground to clear the other object. This relationship implies a sense of motion, agility, and interaction, as the jumping object momentarily maintains an elevated position above the other object while overcoming it in a single leap or bound. The term "jumping over" helps to convey the arrangement and interaction between objects within an image, enabling a better understanding of the scene or composition. For example, a person "jumping over" a hurdle, a kangaroo "jumping over" a fence, or a dolphin "jumping over" a wave. This spatial relationship can be observed in various contexts and is essential in grasping the placement, organization, and connection of objects within an image, emphasizing the dynamic nature of the scene and the ongoing change in position and altitude between the involved elements.',
    '"Jumping from" is a term used to describe the spatial relationship between two objects in an image, where one object, typically a living being like a person or an animal, is in the process of propelling itself through the air by exerting force against the surface of the other object. This relationship implies a sense of motion, agility, and interaction, as the jumping object detaches itself from the other object and momentarily maintains an elevated position above it while moving in a specific direction or towards a target. The term "jumping from" helps to convey the arrangement and interaction between objects within an image, enabling a better understanding of the scene or composition. For example, a person "jumping from" a diving board, a squirrel "jumping from" one tree branch to another, or a base jumper "jumping from" a cliff. This spatial relationship can be observed in various contexts and is essential in grasping the placement, organization, and connection of objects within an image, emphasizing the dynamic nature of the scene and the ongoing change in position and altitude between the involved elements.',
    '"Wearing" is a term used to describe the spatial relationship between two objects in an image, where one object, typically a person or an animal, has the other object, usually an item of clothing, accessory, or protective gear, placed on or around their body in a manner that covers, supports, or adorns it. This relationship implies a sense of attachment, functionality, and interaction, as the wearing object becomes an extension of the wearer, often enhancing or modifying their appearance, providing comfort, or serving a specific purpose. The term "wearing" helps to convey the arrangement and interaction between objects within an image, enabling a better understanding of the scene or composition. For example, a person "wearing" a hat, a dog "wearing" a collar, or a cyclist "wearing" a helmet. This spatial relationship can be observed in various contexts and is essential in grasping the placement, organization, and connection of objects within an image, emphasizing the intimate and functional association between the wearer and the item being worn.',
    '"Holding" is a term used to describe the spatial relationship between two objects in an image, where one object, typically a person or an animal, grasps, supports, or carries the other object using their hands, limbs, or appendages. This relationship implies a sense of control, interaction, and attachment, as the holding object is actively engaged with the other object, maintaining direct contact and ensuring its stability or transport. The term "holding" helps to convey the arrangement and interaction between objects within an image, enabling a better understanding of the scene or composition. For example, a person "holding" a book, a monkey "holding" a fruit, or a bird "holding" a twig in its beak. This spatial relationship can be observed in various contexts and is essential in grasping the placement, organization, and connection of objects within an image, emphasizing the active and purposeful association between the holder and the item being held.',
    '"Carrying" is a term used to describe the spatial relationship between two objects in an image, where one object, typically a person or an animal, supports, transports, or holds the other object using their hands, limbs, appendages, or body. This relationship implies a sense of responsibility, interaction, and attachment, as the carrying object actively engages with the other object, maintaining direct or indirect contact while ensuring its transport or safekeeping. The term "carrying" helps to convey the arrangement and interaction between objects within an image, enabling a better understanding of the scene or composition. For example, a person "carrying" a backpack, an ant "carrying" a leaf, or a stork "carrying" a bundle in its beak. This spatial relationship can be observed in various contexts and is essential in grasping the placement, organization, and connection of objects within an image, emphasizing the active and purposeful association between the carrier and the item being carried.',
    '"Looking at" is a term used to describe the spatial relationship between two objects in an image, where one object, typically a person or an animal, directs their gaze or attention towards the other object. This relationship implies a sense of focus, interest, and interaction, as the looking object visually engages with the other object, often denoting curiosity, observation, or recognition. The term "looking at" helps to convey the arrangement and interaction between objects within an image, enabling a better understanding of the scene or composition. For example, a person "looking at" a painting, a cat "looking at" a fishbowl, or a bird "looking at" its reflection in a mirror. This spatial relationship can be observed in various contexts and is essential in grasping the placement, organization, and connection of objects within an image, emphasizing the cognitive and perceptive association between the observer and the item being observed.',
    '"Guiding" is a term used to describe the spatial relationship between two objects in an image, where one object, typically a person or an animal, leads or directs the other object along a specific path or towards a destination. This relationship implies a sense of leadership, interaction, and cooperation, as the guiding object actively engages with the other object, providing direction, support, or instruction to ensure proper navigation or movement. The term "guiding" helps to convey the arrangement and interaction between objects within an image, enabling a better understanding of the scene or composition. For example, a person "guiding" a blindfolded individual, a dog "guiding" a herd of sheep, or a teacher "guiding" a group of students on a field trip. This spatial relationship can be observed in various contexts and is essential in grasping the placement, organization, and connection of objects within an image, emphasizing the active and purposeful association between the guide and the entity being guided.',
    '"Kissing" is a term used to describe the spatial relationship between two objects in an image, where one object, typically a person or an animal, presses their lips or mouth against the other object or another individual, often as an expression of affection, greeting, or respect. This relationship implies a sense of intimacy, emotion, and interaction, as the kissing object actively engages with the other object or individual, creating a moment of closeness and connection. The term "kissing" helps to convey the arrangement and interaction between objects within an image, enabling a better understanding of the scene or composition. For example, a person "kissing" their partner, a child "kissing" a parent, or a dog "kissing" its owner. This spatial relationship can be observed in various contexts and is essential in grasping the placement, organization, and connection of objects within an image, emphasizing the affectionate and emotive association between the individuals or entities involved in the act of kissing.',
    '"Eating" is a term used to describe the spatial relationship between two objects in an image, where one object, typically a person or an animal, consumes the other object, usually food or a meal, by taking it into their mouth, chewing, and swallowing. This relationship implies a sense of nourishment, enjoyment, and interaction, as the eating object actively engages with the other object, extracting sustenance, taste, and energy from it. The term "eating" helps to convey the arrangement and interaction between objects within an image, enabling a better understanding of the scene or composition. For example, a person "eating" a sandwich, a squirrel "eating" a nut, or a fish "eating" plankton. This spatial relationship can be observed in various contexts and is essential in grasping the placement, organization, and connection of objects within an image, emphasizing the ongoing and purposeful association between the consumer and the item being consumed.',
    '"Drinking" is a term used to describe the spatial relationship between two objects in an image, where one object, typically a person or an animal, consumes the other object, usually a liquid such as water, juice, or other beverages, by taking it into their mouth and swallowing. This relationship implies a sense of hydration, enjoyment, and interaction, as the drinking object actively engages with the other object, obtaining refreshment, taste, and nourishment from it. The term "drinking" helps to convey the arrangement and interaction between objects within an image, enabling a better understanding of the scene or composition. For example, a person "drinking" from a glass of water, a dog "drinking" from a bowl, or a hummingbird "drinking" nectar from a flower. This spatial relationship can be observed in various contexts and is essential in grasping the placement, organization, and connection of objects within an image, emphasizing the ongoing and purposeful association between the consumer and the item being consumed.',
    '"Feeding" is a term used to describe the spatial relationship between two objects in an image, where one object, typically a person, an animal, or a tool, provides food or nourishment to the other object, which can be another person, an animal, or even a plant. This relationship implies a sense of care, interaction, and support, as the feeding object actively engages with the other object, ensuring that it receives sustenance and nourishment necessary for growth, health, or survival. The term "feeding" helps to convey the arrangement and interaction between objects within an image, enabling a better understanding of the scene or composition. For example, a person "feeding" a baby with a spoon, a bird "feeding" its chicks in the nest, or a gardener "feeding" plants with a watering can or fertilizer. This spatial relationship can be observed in various contexts and is essential in grasping the placement, organization, and connection of objects within an image, emphasizing the nurturing and purposeful association between the provider and the recipient of the sustenance.',
    '"Biting" is a term used to describe the spatial relationship between two objects in an image, where one object, typically a person or an animal, uses their teeth or jaws to firmly grip, puncture, or tear the other object, which can be food, an item, or even another living being. This relationship implies a sense of interaction, force, and potentially aggression or playfulness, as the biting object actively engages with the other object, applying pressure or causing damage to it. The term "biting" helps to convey the arrangement and interaction between objects within an image, enabling a better understanding of the scene or composition. For example, a person "biting" into an apple, a dog "biting" a toy, or a snake "biting" its prey. This spatial relationship can be observed in various contexts and is essential in grasping the placement, organization, and connection of objects within an image, emphasizing the forceful and purposeful association between the biter and the object being bitten.',
    '"Catching" is a term used to describe the spatial relationship between two objects in an image, where one object, typically a person or an animal, intercepts, receives, or grasps the other object, usually an item in motion, such as a ball, frisbee, or any other moving object. This relationship implies a sense of interaction, coordination, and timing, as the catching object actively engages with the other object, stopping its movement or trajectory and taking control of it. The term "catching" helps to convey the arrangement and interaction between objects within an image, enabling a better understanding of the scene or composition. For example, a person "catching" a baseball, a dog "catching" a frisbee in mid-air, or a goalkeeper "catching" a soccer ball during a match. This spatial relationship can be observed in various contexts and is essential in grasping the placement, organization, and connection of objects within an image, emphasizing the skillful and dynamic association between the catcher and the object being caught.',
    '"Picking" is a term used to describe the spatial relationship between two objects in an image, where one object, typically a person or an animal, selects, removes, or detaches the other object, often from a larger collection, a surface, or a source. This relationship implies a sense of interaction, choice, and purpose, as the picking object actively engages with the other object, exercising discretion or fulfilling a specific intent. The term "picking" helps to convey the arrangement and interaction between objects within an image, enabling a better understanding of the scene or composition. For example, a person "picking" a fruit from a tree, a child "picking" a toy from a shelf, or a bird "picking" a worm from the ground. This spatial relationship can be observed in various contexts and is essential in grasping the placement, organization, and connection of objects within an image, emphasizing the selective and intentional association between the picker and the object being picked.',
    '"Playing with" is a term used to describe the spatial relationship between two objects in an image, where one object, typically a person or an animal, engages with the other object in a manner that is fun, entertaining, or recreational. This relationship implies a sense of interaction, enjoyment, and exploration, as the playing object actively engages with the other object, often with a lighthearted or leisurely intent, aiming to derive amusement or relaxation from the activity. The term "playing with" helps to convey the arrangement and interaction between objects within an image, enabling a better understanding of the scene or composition. For example, a child "playing with" a toy car, a dog "playing with" a ball, or a group of friends "playing with" a board game. This spatial relationship can be observed in various contexts and is essential in grasping the placement, organization, and connection of objects within an image, emphasizing the entertaining and pleasurable association between the player and the object being played with.',
    '"Chasing" is a term used to describe the spatial relationship between two objects in an image, where one object, typically a person or an animal, pursues the other object, which can be another person, an animal, or a moving item, with the intent of catching or reaching it. This relationship implies a sense of interaction, motion, and determination, as the chasing object actively engages with the other object, often with a goal or purpose in mind. The term "chasing" helps to convey the arrangement and interaction between objects within an image, enabling a better understanding of the scene or composition. For example, a person "chasing" after a bus, a cat "chasing" a toy, or a police officer "chasing" a suspect. This spatial relationship can be observed in various contexts and is essential in grasping the placement, organization, and connection of objects within an image, emphasizing the dynamic and goal-oriented association between the chaser and the object being chased.',
    '"Climbing" is a term used to describe the spatial relationship between two objects in an image, where one object, typically a person or an animal, ascends or moves upward on the other object, which can be a structure, a surface, or a natural formation. This relationship implies a sense of interaction, effort, and vertical motion, as the climbing object actively engages with the other object, using strength, skill, or agility to overcome the challenge of elevation. The term "climbing" helps to convey the arrangement and interaction between objects within an image, enabling a better understanding of the scene or composition. For example, a person "climbing" a rock wall, a monkey "climbing" a tree, or a mountaineer "climbing" a steep mountain slope. This spatial relationship can be observed in various contexts and is essential in grasping the placement, organization, and connection of objects within an image, emphasizing the determined and physically demanding association between the climber and the object being climbed.',
    '"Cleaning" is a term used to describe the spatial relationship between two objects in an image, where one object, typically a person or a cleaning tool, removes dirt, dust, stains, or clutter from the other object, which can be a surface, an item, or a space. This relationship implies a sense of interaction, care, and maintenance, as the cleaning object actively engages with the other object, restoring it to a more orderly, hygienic, or visually pleasing state. The term "cleaning" helps to convey the arrangement and interaction between objects within an image, enabling a better understanding of the scene or composition. For example, a person "cleaning" a window with a squeegee, a vacuum cleaner "cleaning" a carpet, or a dishwasher "cleaning" dirty dishes. This spatial relationship can be observed in various contexts and is essential in grasping the placement, organization, and connection of objects within an image, emphasizing the restorative and orderly association between the cleaner and the object being cleaned.',
    '"Playing" is a term used to describe the spatial relationship between two objects in an image, where one object, typically a person or an animal, interacts with the other object in a fun, engaging, or recreational manner. This relationship implies a sense of interaction, enjoyment, and entertainment, as the playing object actively engages with the other object, focusing on deriving pleasure, amusement, or relaxation from the activity. The term "playing" helps to convey the arrangement and interaction between objects within an image, enabling a better understanding of the scene or composition. For example, a musician "playing" a guitar, children "playing" with building blocks, or a cat "playing" with a ball of yarn. This spatial relationship can be observed in various contexts and is essential in grasping the placement, organization, and connection of objects within an image, emphasizing the lighthearted, enjoyable, and often creative association between the player and the object being played with.',
    '"Touching" is a term used to describe the spatial relationship between two objects in an image, where one object, typically a person, an animal, or a tool, comes into direct physical contact with the other object, which can be another person, an item, or a surface. This relationship implies a sense of interaction, connection, and sensory experience, as the touching object actively engages with the other object, establishing a link or transferring information, emotions, or energy between them. The term "touching" helps to convey the arrangement and interaction between objects within an image, enabling a better understanding of the scene or composition. For example, a person "touching" a sculpture in an art gallery, a hand "touching" a screen on a smartphone, or a dog "touching" its owner\'s leg with its paw. This spatial relationship can be observed in various contexts and is essential in grasping the placement, organization, and connection of objects within an image, emphasizing the intimate, informative, or emotional association between the toucher and the object being touched.',
    '"Pushing" is a term used to describe the spatial relationship between two objects in an image, where one object, typically a person or an animal, exerts force on the other object in order to move or shift it in a specific direction. This relationship implies a sense of interaction, effort, and intent, as the pushing object actively engages with the other object, applying pressure or force to change its position, orientation, or motion. The term "pushing" helps to convey the arrangement and interaction between objects within an image, enabling a better understanding of the scene or composition. For example, a person "pushing" a shopping cart in a supermarket, a bulldozer "pushing" dirt on a construction site, or a child "pushing" a toy car across the floor. This spatial relationship can be observed in various contexts and is essential in grasping the placement, organization, and connection of objects within an image, emphasizing the forceful, purposeful, and dynamic association between the pusher and the object being pushed.',
    '"Pulling" is a term used to describe the spatial relationship between two objects in an image, where one object, typically a person or an animal, exerts force on the other object in order to move or shift it toward themselves or in a specific direction. This relationship implies a sense of interaction, effort, and intent, as the pulling object actively engages with the other object, applying tension or force to change its position, orientation, or motion. The term "pulling" helps to convey the arrangement and interaction between objects within an image, enabling a better understanding of the scene or composition. For example, a person "pulling" a suitcase on wheels through an airport, a horse "pulling" a carriage down a street, or a child "pulling" a toy on a string across the floor. This spatial relationship can be observed in various contexts and is essential in grasping the placement, organization, and connection of objects within an image, emphasizing the forceful, purposeful, and dynamic association between the puller and the object being pulled.',
    '"Opening" is a term used to describe the spatial relationship between two objects in an image, where one object, typically a person or a mechanism, acts upon the other object to reveal or expose its contents, interior, or inner space. This relationship implies a sense of interaction, effort, and intent, as the opening object actively engages with the other object, altering its state or configuration to make it accessible, visible, or usable. The term "opening" helps to convey the arrangement and interaction between objects within an image, enabling a better understanding of the scene or composition. For example, a person "opening" a door to enter a room, a hand "opening" a jar to access its contents, or a key "opening" a lock to secure or release a mechanism. This spatial relationship can be observed in various contexts and is essential in grasping the placement, organization, and connection of objects within an image, emphasizing the revealing, transformative, and functional association between the opener and the object being opened.',
    '"Cooking" is a term used to describe the spatial relationship between two objects in an image, where one object, typically a person or a cooking appliance, acts upon the other object, usually food or ingredients, to transform, combine, or prepare them for consumption. This relationship implies a sense of interaction, skill, and intent, as the cooking object actively engages with the other object, applying heat, mixing, or other techniques to create a flavorful, nutritious, or visually appealing dish. The term "cooking" helps to convey the arrangement and interaction between objects within an image, enabling a better understanding of the scene or composition. For example, a chef "cooking" a meal in a restaurant kitchen, a pot "cooking" soup on a stovetop, or a baker "cooking" a cake in an oven. This spatial relationship can be observed in various contexts and is essential in grasping the placement, organization, and connection of objects within an image, emphasizing the creative, transformative, and nurturing association between the cook and the object being cooked.',
    '"Talking to" is a term used to describe the spatial relationship between two objects in an image, where one object, typically a person or an animal capable of communication, engages in a verbal interaction with the other object, which can be another person, an animal, or even a device. This relationship implies a sense of interaction, connection, and exchange, as the talking object actively engages with the other object, sharing information, thoughts, emotions, or ideas through spoken language or vocalizations. The term "talking to" helps to convey the arrangement and interaction between objects within an image, enabling a better understanding of the scene or composition. For example, a person "talking to" a friend in a park, a teacher "talking to" students in a classroom, or a human "talking to" a voice-controlled smart device. This spatial relationship can be observed in various contexts and is essential in grasping the placement, organization, and connection of objects within an image, emphasizing the communicative, informative, and relational association between the talker and the object being talked to.',
    '"Throwing" is a term used to describe the spatial relationship between two objects in an image, where one object, typically a person or an animal, exerts force to propel the other object, usually an item or a projectile, through the air. This relationship implies a sense of interaction, effort, and intent, as the throwing object actively engages with the other object, applying force and releasing it in a specific direction to achieve a desired outcome or effect. The term "throwing" helps to convey the arrangement and interaction between objects within an image, enabling a better understanding of the scene or composition. For example, a baseball player "throwing" a ball during a game, a child "throwing" a toy airplane in a park, or a dog "throwing" a stick for its owner to fetch. This spatial relationship can be observed in various contexts and is essential in grasping the placement, organization, and connection of objects within an image, emphasizing the forceful, dynamic, and purposeful association between the thrower and the object being thrown.',
    '"Slicing" is a term used to describe the spatial relationship between two objects in an image, where one object, typically a person or a machine, uses a sharp-edged tool or instrument to cut the other object, usually food or a material, into thinner, more manageable pieces. This relationship implies a sense of interaction, precision, and intent, as the slicing object actively engages with the other object, applying controlled pressure and movement to create clean, uniform cuts. The term "slicing" helps to convey the arrangement and interaction between objects within an image, enabling a better understanding of the scene or composition. For example, a chef "slicing" vegetables on a cutting board, a person "slicing" a loaf of bread with a serrated knife, or a machine "slicing" through a sheet of metal. This spatial relationship can be observed in various contexts and is essential in grasping the placement, organization, and connection of objects within an image, emphasizing the precise, skillful, and purposeful association between the slicer and the object being sliced.',
    '"Driving" is a term used to describe the spatial relationship between two objects in an image, where one object, typically a person or an autonomous system, controls and operates the other object, usually a vehicle such as a car, bus, or truck, in order to navigate and move it from one location to another. This relationship implies a sense of interaction, skill, and intent, as the driving object actively engages with the other object, managing its speed, direction, and other operational aspects. The term "driving" helps to convey the arrangement and interaction between objects within an image, enabling a better understanding of the scene or composition. For example, a person "driving" a car down a highway, a bus driver "driving" a bus full of passengers, or an autonomous vehicle "driving" itself along a predetermined route. This spatial relationship can be observed in various contexts and is essential in grasping the placement, organization, and connection of objects within an image, emphasizing the dynamic, controlled, and purposeful association between the driver and the object being driven.',
    '"Riding" is a term used to describe the spatial relationship between two objects in an image, where one object, typically a person or an animal, is seated or positioned on the other object, usually a vehicle, animal, or apparatus, for the purpose of transportation, recreation, or sport. This relationship implies a sense of interaction, balance, and cooperation, as the riding object actively engages with the other object, maintaining its position and often controlling or guiding its movement to achieve a desired outcome or destination. The term "riding" helps to convey the arrangement and interaction between objects within an image, enabling a better understanding of the scene or composition. For example, a person "riding" a bicycle on a bike path, a child "riding" a carousel horse at an amusement park, or a cowboy "riding" a horse across a field. This spatial relationship can be observed in various contexts and is essential in grasping the placement, organization, and connection of objects within an image, emphasizing the dynamic, engaging, and sometimes adventurous association between the rider and the object being ridden.',
    '"Parked on" is a term used to describe the spatial relationship between two objects in an image, where one object, typically a vehicle such as a car, motorcycle, or bicycle, is stationary and positioned on the other object, usually a surface or designated area, while not in active use. This relationship implies a sense of inactivity, resting, and temporary placement, as the parked object remains motionless on the other object, waiting to be used or moved at a later time. The term "parked on" helps to convey the arrangement and interaction between objects within an image, enabling a better understanding of the scene or composition. For example, a car "parked on" the side of a street, a bicycle "parked on" a bike rack, or a motorcycle "parked on" a parking spot. This spatial relationship can be observed in various contexts and is essential in grasping the placement, organization, and connection of objects within an image, emphasizing the stationary, orderly, and temporarily inactive association between the parked object and the surface or area it is parked on.',
    '"Driving on" is a term used to describe the spatial relationship between two objects in an image, where one object, typically a person or an autonomous system, is actively controlling and operating the other object, usually a vehicle such as a car, truck, or bus, as it moves along a surface or a designated path. This relationship implies a sense of interaction, skill, and purpose, as the driving object engages with the other object to navigate, maintain speed, and follow a specific route or direction. The term "driving on" helps to convey the arrangement and interaction between objects within an image, enabling a better understanding of the scene or composition. For example, a car "driving on" a highway, a truck "driving on" a rural road, or an autonomous vehicle "driving on" a predetermined route in an urban setting. This spatial relationship can be observed in various contexts and is essential in grasping the placement, organization, and connection of objects within an image, emphasizing the dynamic, controlled, and goal-oriented association between the driver or the controlling system and the object being driven on the surface or path.',
    '"About to hit" is a term used to describe the spatial relationship between two objects in an image, where one object, typically moving or in motion, is very close to or approaching the other object in such a way that a collision or impact appears imminent. This relationship implies a sense of urgency, danger, and anticipation, as the moving object is on the verge of making contact with the other object, potentially causing harm, damage, or disruption. The term "about to hit" helps to convey the arrangement and interaction between objects within an image, enabling a better understanding of the scene or composition. For example, a car "about to hit" a pedestrian crossing the street, a baseball "about to hit" a window, or a falling object "about to hit" the ground. This spatial relationship can be observed in various contexts and is essential in grasping the placement, organization, and connection of objects within an image, emphasizing the critical, alarming, and potentially harmful association between the moving object and the object it is about to hit.',
    '"Kicking" is a term used to describe the spatial relationship between two objects in an image, where one object, typically a person or an animal, uses their leg or foot to forcefully strike, propel, or move the other object, often a ball, an object on the ground, or even another person or animal. This relationship implies a sense of interaction, strength, and intent, as the kicking object actively engages with the other object, applying force and controlled motion to achieve a desired outcome, such as scoring a goal or moving the object to a different location. The term "kicking" helps to convey the arrangement and interaction between objects within an image, enabling a better understanding of the scene or composition. For example, a soccer player "kicking" a ball towards the goal, a person "kicking" a can on the ground, or a martial artist "kicking" an opponent during a match. This spatial relationship can be observed in various contexts and is essential in grasping the placement, organization, and connection of objects within an image, emphasizing the dynamic, powerful, and purposeful association between the kicker and the object being kicked.',
    '"Swinging" is a term used to describe the spatial relationship between two objects in an image, where one object, typically a person, moves or rotates the other object, such as a piece of equipment, a tool, or a limb, in a sweeping, arc-like motion. This relationship implies a sense of interaction, momentum, and rhythm, as the swinging object actively engages with the other object, creating a fluid, circular, or pendulum-like movement to achieve a specific outcome, such as generating force, momentum, or entertainment. The term "swinging" helps to convey the arrangement and interaction between objects within an image, enabling a better understanding of the scene or composition. For example, a child "swinging" on a playground swing, a golfer "swinging" a golf club to hit a ball, or a dancer "swinging" their partner during a dance routine. This spatial relationship can be observed in various contexts and is essential in grasping the placement, organization, and connection of objects within an image, emphasizing the dynamic, graceful, and often energetic association between the swinger and the object being swung.',
    '"Entering" is a term used to describe the spatial relationship between two objects in an image, where one object, typically a person or an object, moves or advances towards another object, often a space, a building, or a room, to gain access or become part of it. This relationship implies a sense of movement, transition, and purpose, as the entering object actively engages with the other object, crossing a boundary or threshold to enter a new space, environment, or situation. The term "entering" helps to convey the arrangement and interaction between objects within an image, enabling a better understanding of the scene or composition. For example, a person "entering" a building, a vehicle "entering" a garage, or an athlete "entering" a competition field. This spatial relationship can be observed in various contexts and is essential in grasping the placement, organization, and connection of objects within an image, emphasizing the dynamic, purposeful, and often transformative association between the entering object and the space or object being entered.',
    '"Exiting" is a term used to describe the spatial relationship between two objects in an image, where one object, typically a person or an object, moves or advances away from another object, often a space, a building, or a room, to leave or depart from it. This relationship implies a sense of movement, transition, and closure, as the exiting object actively disengages from the other object, crossing a boundary or threshold to exit a space, environment, or situation. The term "exiting" helps to convey the arrangement and interaction between objects within an image, enabling a better understanding of the scene or composition. For example, a person "exiting" a building, a vehicle "exiting" a garage, or an athlete "exiting" a competition field. This spatial relationship can be observed in various contexts and is essential in grasping the placement, organization, and connection of objects within an image, emphasizing the dynamic, purposeful, and often transformative association between the exiting object and the space or object being exited.',
    '"Enclosing" is a term used to describe the spatial relationship between two objects in an image, where one object, typically a structure or a container, completely surrounds, encircles, or encases another object, often a smaller or more delicate object, to provide protection, containment, or support. This relationship implies a sense of containment, protection, and stability, as the enclosing object creates a safe and secure space for the enclosed object to exist within. The term "enclosing" helps to convey the arrangement and interaction between objects within an image, enabling a better understanding of the scene or composition. For example, a birdhouse "enclosing" a bird\'s nest, a cage "enclosing" an animal, or a box "enclosing" a valuable item. This spatial relationship can be observed in various contexts and is essential in grasping the placement, organization, and connection of objects within an image, emphasizing the protective, supportive, and often nurturing association between the enclosing object and the enclosed object.',
    '"Leaning on" is a term used to describe the spatial relationship between two objects in an image, where one object, typically a person or an object, rests or presses against another object, often a surface or another object, for support, balance, or relaxation. This relationship implies a sense of stability, comfort, and relaxation, as the leaning object uses the other object to stabilize itself or to rest comfortably. The term "leaning on" helps to convey the arrangement and interaction between objects within an image, enabling a better understanding of the scene or composition. For example, a person "leaning on" a railing, a piece of furniture "leaning on" a wall, or a ladder "leaning on" a building. This spatial relationship can be observed in various contexts and is essential in grasping the placement, organization, and connection of objects within an image, emphasizing the relaxed, comfortable, and often functional association between the leaning object and the object being leaned upon.',
]
relation_description_v1 = [
    'The relationship between two objects is "{}"'.format(x) for x in relation_classes
]
relation_description_dict = {
    'relation_classes': relation_classes,
    'relation_description_gpt4_v0': relation_description_gpt4_v0,
    'relation_description_v1': relation_description_v1,
}


class COCOPanopticRelation(COCOPanoptic):
    def createIndex(self):
        # create index
        print('creating index...')
        # anns stores 'segment_id -> annotation'
        anns, cats, imgs = {}, {}, {}
        relations = {}

        img_to_anns, cat_to_imgs = defaultdict(list), defaultdict(list)
        if 'annotations' in self.dataset:
            for ann, img_info in zip(self.dataset['annotations'],
                                     self.dataset['images']):
                img_info['segm_file'] = ann['file_name']
                for seg_ann in ann['segments_info']:
                    # to match with instance.json
                    seg_ann['image_id'] = ann['image_id']
                    seg_ann['height'] = img_info['height']
                    seg_ann['width'] = img_info['width']
                    img_to_anns[ann['image_id']].append(seg_ann)
                    # segment_id is not unique in coco dataset orz...
                    if seg_ann['id'] in anns.keys():
                        anns[seg_ann['id']].append(seg_ann)
                    else:
                        anns[seg_ann['id']] = [seg_ann]

                relations[ann['image_id']] = ann['relations']

        if 'images' in self.dataset:
            for img in self.dataset['images']:
                imgs[img['id']] = img

        if 'categories' in self.dataset:
            for cat in self.dataset['categories']:
                cats[cat['id']] = cat

        if 'annotations' in self.dataset and 'categories' in self.dataset:
            for ann in self.dataset['annotations']:
                for seg_ann in ann['segments_info']:
                    cat_to_imgs[seg_ann['category_id']].append(ann['image_id'])

        print('index created!')

        self.anns = anns
        self.imgToAnns = img_to_anns
        self.catToImgs = cat_to_imgs
        self.imgs = imgs
        self.cats = cats
        self.relations = relations


@DATASETS.register_module()
class CocoPanopticRelationDataset(CocoPanopticDataset):
    def load_annotations(self, ann_file):
        """Load annotation from COCO Panoptic style annotation file.

        Args:
            ann_file (str): Path of annotation file.

        Returns:
            list[dict]: Annotation info from COCO api.
        """
        self.coco = COCOPanopticRelation(ann_file)
        self.cat_ids = self.coco.get_cat_ids()
        self.cat2label = {cat_id: i for i, cat_id in enumerate(self.cat_ids)}
        self.categories = self.coco.cats
        self.img_ids = self.coco.get_img_ids()
        data_infos = []
        for i in self.img_ids:
            info = self.coco.load_imgs([i])[0]
            info['filename'] = info['file_name']
            if 'segm_file' in info:
                info['segm_file'] = info['segm_file']
            else:
                info['segm_file'] = info['filename'].replace('jpg', 'png')
            data_infos.append(info)

        self.imgid2relations = self.coco.relations
        return data_infos

    def _parse_ann_info(self, img_info, ann_info):
        """Parse annotations and load panoptic ground truths.

        Args:
            img_info (int): Image info of an image.
            ann_info (list[dict]): Annotation info of an image.

        Returns:
            dict: A dict containing the following keys: bboxes, bboxes_ignore,
                labels, masks, seg_map.
        """
        gt_bboxes = []
        gt_labels = []
        gt_bboxes_ignore = []
        gt_mask_infos = []
        gt_rels = []

        for i, ann in enumerate(ann_info):
            x1, y1, w, h = ann['bbox']
            if ann['area'] <= 0 or w < 1 or h < 1:
                continue
            bbox = [x1, y1, x1 + w, y1 + h]

            category_id = ann['category_id']
            contiguous_cat_id = self.cat2label[category_id]

            is_thing = self.coco.load_cats(ids=category_id)[0]['isthing']
            if is_thing:
                is_crowd = ann.get('iscrowd', False)
                if not is_crowd:
                    gt_bboxes.append(bbox)
                    gt_labels.append(contiguous_cat_id)
                else:
                    gt_bboxes_ignore.append(bbox)
                    is_thing = False

            mask_info = {
                'id': ann['id'],
                'category': contiguous_cat_id,
                'is_thing': is_thing
            }
            gt_mask_infos.append(mask_info)

        image_id = ann['image_id']
        rel = self.imgid2relations[image_id]
        gt_rels.append(rel)

        if gt_bboxes:
            gt_bboxes = np.array(gt_bboxes, dtype=np.float32)
            gt_labels = np.array(gt_labels, dtype=np.int64)
        else:
            gt_bboxes = np.zeros((0, 4), dtype=np.float32)
            gt_labels = np.array([], dtype=np.int64)

        if gt_bboxes_ignore:
            gt_bboxes_ignore = np.array(gt_bboxes_ignore, dtype=np.float32)
        else:
            gt_bboxes_ignore = np.zeros((0, 4), dtype=np.float32)

        ann = dict(
            bboxes=gt_bboxes,
            labels=gt_labels,
            bboxes_ignore=gt_bboxes_ignore,
            masks=gt_mask_infos,
            seg_map=img_info['segm_file'],
            relations=gt_rels,
        )
        return ann
